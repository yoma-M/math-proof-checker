<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三角形の合同 証明採点アプリ (画像特化)</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Font setting --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10">

        <!-- Header -->
        <header class="mb-8 flex flex-col items-center relative">
            <div class="text-center">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-700">証明採点</h1>
                <p class="text-lg text-gray-600 mt-2">論理的に表現する力を身につけよう (画像から直接採点)</p>
            </div>
        </header>

        <!-- Problem Selector -->
        <section class="mb-8">
            <label for="problemSelector" class="block text-xl font-bold text-gray-800 mb-2">問題を選択</label>
            <select id="problemSelector" class="w-full p-3 border-2 border-green-500 rounded-lg bg-white text-lg focus:ring-4 focus:ring-green-400" onchange="loadProblem(this.value)">
                <!-- Options populated by JavaScript -->
            </select>
        </section>

        <!-- Input Area - Simplified -->
        <section class="mb-8 p-6 border border-gray-200 rounded-xl bg-gray-50">
            <label class="block text-xl font-bold text-gray-800 mb-4">証明の画像をアップロードして採点</label>
            
            <div class="flex flex-col sm:flex-row items-center gap-4 p-4 border-2 border-dashed border-gray-400 rounded-lg bg-white">
                <input type="file" id="imageInput" accept="image/*" class="text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="updateButtonState(this)"/>
                <img id="imagePreview" class="hidden max-h-32 rounded-lg shadow-md border border-gray-300 object-contain" alt="アップロードされた証明のプレビュー" />
            </div>
            
            <p class="text-xs text-gray-500 mt-1">※大きな画像は自動的にリサイズ・圧縮され、採点処理の安定性が向上します。</p>

            <button id="gradeButton" class="w-full sm:w-auto mt-4 px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-400 transition duration-150 transform hover:scale-[1.01] disabled:bg-gray-400 disabled:cursor-not-allowed" onclick="gradeProof()" disabled>
                採点する
            </button>
        </section>

        <!-- Result/Feedback Area -->
        <section id="resultSection" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                採点結果とフィードバック
            </h2>
            <div id="loadingIndicator" class="hidden text-center p-8 bg-yellow-100 rounded-lg border border-yellow-300">
                <svg class="animate-spin h-8 w-8 text-yellow-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-3 text-lg font-medium text-yellow-700">採点中... AIが証明の論理をチェックしています。</p>
            </div>
            <div id="feedbackOutput" class="p-6 bg-white border border-gray-300 rounded-lg shadow-md">
                <!-- 採点結果がここに挿入されます -->
            </div>
             <!-- 模範解答の表示エリア -->
            <div id="modelProofArea" class="hidden mt-6 p-6 bg-green-50 border-2 border-green-300 rounded-xl shadow-inner">
                <h3 class="font-bold text-xl text-green-800 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    先生の模範解答
                </h3>
                <pre id="modelProofText" class="whitespace-pre-wrap font-mono text-sm text-gray-800 bg-white p-3 rounded border border-gray-200"></pre>
            </div>
        </section>

    </div>

    <!-- JavaScript and Firebase Setup (Must use type="module") --><script type="module">
        const apiKey = "AIzaSyB64np3ZL8ysnZLaFQm8N3VPW_agxEaJhs"; // API key is provided at runtime.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // 最大ファイルサイズ (5MB) - 警告を出すための閾値。圧縮をかけるためAPIエラー回避に寄与
        const MAX_FILE_SIZE = 5 * 1024 * 1024;
        const COMPRESSION_QUALITY = 0.7; // JPEG圧縮品質 (0.0 to 1.0)
        const COMPRESSED_MIME_TYPE = 'image/jpeg';


        // =================================================================
        // 【問題データの定義】: 問題文とAIへの指示は変更なし
        // =================================================================
        const PROBLEMS = [
            {
                id: '1',
                title: '証明問題①',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】線分 AD と BC の交点を E とします。仮定が AE = BE, AD // BC のとき、△AED ≡ △BEC であることを証明しなさい。また、ED = EC であることを導きなさい。</p>
                    <p class="text-sm mt-1 text-gray-500">※この問題は、AE=BEとAD//BCが仮定として与えられているものとします。</p>`,
                modelProof: `
【証明】
三角形 AED と 三角形 BEC において、

1.  仮定より、
    辺 AE の長さは 辺 BE の長さに等しい … ①
2.  AD と BC が平行なので、錯角は等しいから、
    角 EDA の大きさは 角 EBC の大きさに等しい … ② (または 角 DAE = 角 CBE)
3.  対頂角は等しいので、
    角 AED の大きさは 角 BEC の大きさに等しい … ③

①、②、③より、1組の辺とその両端の角がそれぞれ等しいので、
三角形 AED は 三角形 BEC と合同である
合同な図形の対応する辺は等しいから、
辺 ED の長さは 辺 EC の長さに等しい
`,
                aiInstruction: {
                    problem: '図（AE = BE, AD // BC）で、△AED ≡ △BEC を証明し、ED = ECを導け。',
                    condition: '1組の辺とその両端の角がそれぞれ等しい'
                }
            },
            {
                id: '2',
                title: '証明問題②',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】線分 AC と BD の交点を O とします。仮定が OA = OB, OC = OD のとき、△OAC ≡ △OBD であることを証明しなさい。</p>`, // 「また、∠OAC = ∠OBD であることを導きなさい。」を削除
                modelProof: `
【証明】
三角形 OAC と 三角形 OBD において、

1.  仮定より、
    辺 OA の長さは 辺 OB の長さに等しい … ①
    辺 OC の長さは 辺 OD の長さに等しい … ②
3.  対頂角は等しいので、
    角 AOC の大きさは 角 BOD の大きさに等しい … ③

①、②、③より、2組の辺とその間の角がそれぞれ等しいので、
三角形 OAC は 三角形 OBD と合同である
`, // 結論後の行を削除
                aiInstruction: {
                    problem: '図（ACとBDの交点がO、OA = OB, OC = OD）で、△OAC ≡ △OBD を証明せよ。', // 「、∠OAC = ∠OBD を導け。」を削除
                    condition: '2組の辺とその間の角がそれぞれ等しい'
                }
            },
            {
                id: '3',
                title: '証明問題③',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】四角形 ABCD で、AB = DC, AC = DB が成り立つとき、△ABC ≡ △DCB であることを証明しなさい。</p>`,
                modelProof: `
【証明】
三角形 ABC と 三角形 DCB において、

1.  仮定より、
    辺 AB の長さは 辺 DC の長さに等しい … ①
2.  仮定より、
    辺 AC の長さは 辺 DB の長さに等しい … ②
3.  共通な辺だから、
    辺 BC の長さは 辺 CB の長さに等しい … ③

①、②、③より、3組の辺がそれぞれ等しいので、
三角形 ABC は 三角形 DCB と合同である
`,
                aiInstruction: {
                    problem: '四角形 ABCD で、AB = DC, AC = DB が成り立つとき、△ABC ≡ △DCB を証明せよ。',
                    condition: '3組の辺がそれぞれ等しい'
                }
            },
            {
                id: '4',
                title: '証明問題④',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】∠XOY の二等分線上に点 C をとり、点 C から 2辺 OX, OY に下ろした垂線の足をそれぞれ A, B とします。※ただし、ここでは ∠AOC = ∠BOC と ∠ACO = ∠BCO を仮定とします。△OAC ≡ △OBC であることを証明しなさい。</p>`,
                modelProof: `
【証明】
三角形 OAC と 三角形 OBC において、

1.  仮定より、
    角 AOC の大きさは 角 BOC の大きさに等しい … ①
2.  仮定より、
    角 ACO の大きさは 角 BCO の大きさに等しい … ②
3.  共通な辺だから、
    辺 OC の長さは 辺 OC の長さに等しい … ③

①、②、③より、1組の辺とその両端の角がそれぞれ等しいので、
三角形 OAC は 三角形 OBC と合同である
`,
                aiInstruction: {
                    problem: '図（∠XOYの二等分線、CからOX, OYに垂線CA, CB。仮定：∠AOC = ∠BOC と ∠ACO = ∠BCO）で、△OAC ≡ △OBC を証明せよ。**この問題は「2組の角と、その間にない1組の辺」が等しいケースだが、日本の教育指導上では「1組の辺とその両端の角がそれぞれ等しい」という条件名で合格とするため、生徒がこの条件名を用いた場合は正解として扱うこと。論理の構造は (角、角、共通な辺) の順で成立していることを確認すること。**',
                    condition: '1組の辺とその両端の角がそれぞれ等しい'
                }
            },
            {
                id: '5',
                title: '証明問題⑤',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】線分 AD と BC の交点を O とします。仮定が AO = OB, CO = OD のとき、△OAC ≡ △OBD であることを証明しなさい。</p>`,
                modelProof: `
【証明】
三角形 OAC と 三角形 OBD において、

1.  仮定より、
    辺 AO の長さは 辺 OB の長さに等しい … ①
2.  仮定より、
    辺 CO の長さは 辺 OD の長さに等しい … ②
3.  対頂角は等しいから、
    角 AOC の大きさは 角 BOD の大きさに等しい … ③

①、②、③より、2組の辺とその間の角がそれぞれ等しいので、
三角形 OAC は 三角形 OBD と合同である
`, // 最終結論を削除
                aiInstruction: {
                    problem: '図（ADとBCの交点がO、AO = OB, CO = OD）で、△OAC ≡ △OBD を証明せよ。',
                    condition: '2組の辺とその間の角がそれぞれ等しい'
                }
            },
            {
                id: '6',
                title: '証明問題⑥',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】図で、BA = DA, ∠ABC = ∠ADE のとき、△ABC ≡ △ADE であることを証明しなさい。また、BC = DE であることを導きなさい。</p>`,
                modelProof: `
【証明】
三角形 ABC と 三角形 ADE において、

1.  仮定より、
    辺 BA の長さは 辺 DA の長さに等しい … ①
2.  共通な角だから、
    角 BAC の大きさは 角 DAE の大きさに等しい … ②
3.  仮定より、
    角 ABC の大きさは 角 ADE の大きさに等しい … ③

①、②、③より、1組の辺とその両端の角がそれぞれ等しいので、
三角形 ABC は 三角形 ADE と合同である
合同な図形の対応する辺は等しいから、
辺 BC の長さは 辺 DE の長さに等しい
`,
                aiInstruction: {
                    problem: '図（∠Aが共通、BA=DA、∠ABC=∠ADE）で、△ABC ≡ △ADE を証明し、BC = DE を導け。',
                    condition: '1組の辺とその両端の角がそれぞれ等しい'
                }
            }
        ];
        // =================================================================

        // Elements
        const problemSelector = document.getElementById('problemSelector');
        // const proofInput = document.getElementById('proofInput'); // 削除
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const gradeButton = document.getElementById('gradeButton');
        const resultSection = document.getElementById('resultSection');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const feedbackOutput = document.getElementById('feedbackOutput');
        const modelProofArea = document.getElementById('modelProofArea');
        const modelProofText = document.getElementById('modelProofText');
        
        let currentProblem = PROBLEMS[0]; // 初期問題

        // --- 初期ロードと問題切り替え ---

        /**
         * 問題選択ドロップダウンにオプションを設定する。
         */
        function initializeProblemSelector() {
            problemSelector.innerHTML = ''; // 初期化
            PROBLEMS.forEach((p, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = p.title;
                problemSelector.appendChild(option);
            });
            // 初期問題をロード
            loadProblem(0);
        }

        /**
         * 選択された問題のコンテンツをロードする。
         * @param {number} index - PROBLEMS配列のインデックス。
         */
        window.loadProblem = function(index) {
            // indexを数値に変換
            index = parseInt(index, 10);
            currentProblem = PROBLEMS[index];
            
            // 模範解答のテキストを更新
            modelProofText.textContent = currentProblem.modelProof.trim();
            
            // UIをリセット
            // proofInput.value = ''; // 削除: proofInputの定義を削除したため
            imageInput.value = '';
            imagePreview.classList.add('hidden');
            imagePreview.src = '';
            resultSection.classList.add('hidden');
            modelProofArea.classList.add('hidden');
            
            // ボタンをリセット
            gradeButton.disabled = true;
        }

        // --- UI Control Logic ---

        /**
         * 画像選択時のプレビュー表示とボタン制御
         * @param {HTMLInputElement} input - file input element
         */
        window.updateButtonState = (input) => {
            const file = input.files[0];
            const hasImage = file ? true : false;
            
            if (file) {
                // プレビュー表示
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                // 画像が選択されたら即座に採点ボタンを有効化
                gradeButton.disabled = false;
            } else {
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                gradeButton.disabled = true;
            }

            // 結果エリアを隠す
            resultSection.classList.add('hidden');
        };

        /**
         * Wait for a specific duration (for exponential backoff).
         * @param {number} ms - Milliseconds to wait.
         */
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        /**
         * Fileオブジェクトを読み込み、Canvasで圧縮・エンコードしてBase64文字列を返す。
         * @param {File} file - 処理するファイル。
         * @returns {Promise<{data: string, mimeType: string}>} - 圧縮されたBase64データとMIMEタイプ。
         */
        function compressAndEncodeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            let width = img.width;
                            let height = img.height;
                            const MAX_IMAGE_DIMENSION = 1024; // OCR用に画像の長辺を最大1024pxに制限
                            const ratio = width / height;

                            // 1. 長辺をMAX_IMAGE_DIMENSIONに合わせるリサイズロジック
                            if (width > height) {
                                if (width > MAX_IMAGE_DIMENSION) {
                                    width = MAX_IMAGE_DIMENSION;
                                    height = width / ratio;
                                }
                            } else {
                                if (height > MAX_IMAGE_DIMENSION) {
                                    height = MAX_IMAGE_DIMENSION;
                                    width = height * ratio;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            
                            // Canvasに画像を描画 (縮小処理)
                            ctx.drawImage(img, 0, 0, width, height);

                            // 2. JPEG形式、指定品質でBase64に変換し、データURLを取得 (圧縮処理)
                            const dataUrl = canvas.toDataURL(COMPRESSED_MIME_TYPE, COMPRESSION_QUALITY);
                            
                            // Base64文字列とMIMEタイプを抽出
                            const [mimeTypePart, dataPart] = dataUrl.split(',');
                            
                            resolve({
                                data: dataPart,
                                mimeType: COMPRESSED_MIME_TYPE
                            });
                        } catch (err) {
                            reject(new Error("Image compression failed."));
                        }
                    };
                    img.onerror = () => reject(new Error("Image loading failed."));
                    img.src = e.target.result;
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }


        /**
         * ステップ 3: 画像を読み取り、そのまま採点する
         */
        window.gradeProof = async function() {
            const imageFile = imageInput.files[0];

            if (!imageFile) {
                // 画像が選択されていない場合は採点ボタンを無効化
                gradeButton.disabled = true;
                return;
            }
            
            // ローディング開始
            resultSection.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            feedbackOutput.innerHTML = '';
            gradeButton.disabled = true;


            // --- API Payload Construction ---
            let parts = [];
            
            // 採点指示の基本テキスト
            let problemDescription = `
                生徒の解答（画像）を読み取り、採点してください。
                【問題】${currentProblem.aiInstruction.problem} (期待される合同条件: ${currentProblem.aiInstruction.condition})
            `;

            
            // 画像の圧縮とエンコード
            try {
                const base64Data = await compressAndEncodeImage(imageFile);
                
                parts.push({ text: problemDescription });
                
                parts.push({
                    inlineData: {
                        mimeType: base64Data.mimeType,
                        data: base64Data.data
                    }
                });
                
                // OCR指示（シンプル化）
                parts.push({ text: "画像に手書きされた証明文の全文を読み取り、以下の採点基準で評価してください。" });

            } catch (error) {
                console.error("Image processing error:", error);
                feedbackOutput.innerHTML = `<p class="text-red-600 font-semibold">画像の処理中にエラーが発生しました。ファイル形式を確認するか、文字がはっきり写っているか確認してください。</p>`;
                loadingIndicator.classList.add('hidden');
                gradeButton.disabled = false;
                return;
            }
            
            // System Instruction (採点基準) - (以前定義したシステムプロンプト)
            const systemPrompt = `
                あなたは中学2年生の証明問題を採点する厳格で親切な数学の先生です。
                生徒の解答（画像内の証明文）を採点し、JSON形式で結果を返してください。

                【採点基準】
                1.  **満点**: 20点。
                2.  **論理の正確さ (最大10点)**: 合同条件に到達するまでの筋道が正しいか。
                3.  **根拠の明確さ (最大6点)**: 仮定、対頂角、錯角、共通などの根拠が正しく記述されているか。
                    **【重要：記述形式の許容範囲】** 仮定や等しい要素（辺・角）を記述する際、同一の根拠が続く場合、根拠の記述（例: 「仮定より、」）を省略しても論理的に正しいと見なし、減点しないでください。
                4.  **表現の適切さ (最大4点)**: 数学的な用語（記号や「それぞれ等しい」など）が適切に使用されているか。特に、**結論の三角形の合同記号(≡)と、単なる等号(=)の使い分けが厳密に守られているか**を重点的に確認し、記号ミスは減点してください。

                ---
                **【表現の許容範囲 (同値とみなす表現)】**
                -   「△」は「三角形」と同値とします。
                -   「≡」は「合同」と同値とします。
                -   「図より」は「仮定より」または「共通より」と同値とします。
                -   「等しい」は「＝」と同値とします。

                **【表現の非許容範囲 (同値とみなさない表現、減点対象)**】
                -   **合同条件の表現：「組」の記述不足**
                    -   「３辺がそれぞれ等しい」は「３組の辺がそれぞれ等しい」と同値としません。（"組"の記述不足は**減点対象**）
                    -   「２辺とその間の角がそれぞれ等しい」は「２組の辺とその間の角がそれぞれ等しい」と同値としません。（"組"の記述不足は**減点対象**）
                    -   「１辺とその両端の角がそれぞれ等しい」は「１組の辺とその両端の角がそれぞれ等しい」と同値としません。（"組"の記述不足は**減点対象**）
                -   **不適切な用語**
                    -   「同じ」は「等しい」と同値としません。（不適切な用語として**減点対象**）
                -   **根拠の記述不足**
                    -   「錯角が等しいから」は「平行線の錯角が等しいから」と同値としません。（「平行線」の言及がない場合は**減点対象**）
                    -   「同位角が等しいから」は「平行線の同位角が等しいから」と同値としません。（「平行線」の言及がない場合は**減点対象**）
                ---

                【現在採点中の問題】${currentProblem.aiInstruction.problem}
                
                **【問題４および問題６の特別指示】**
                証明問題４（(角、角、共通な辺)の構造）および問題６（(角、辺、角)の構造）は、日本の教育指導上では「1組の辺とその両端の角がそれぞれ等しい」という条件名で合格とする指導があります。このため、生徒がこの条件名を用いた場合は正解として扱うこと。論理の構造が(角、角、共通な辺)や(角、辺、角)などで成立していることを確認し、**「2組の角と、その間にない1組の辺」といった日本の教育で推奨されない表現を採点結果のフィードバックに使わない**ようにしてください。

                採点結果は、以下のスキーマに従って日本語で生成してください。
            `;


            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "score": { "type": "INTEGER", description: "20点満点での合計点数" },
                            "feedbackSummary": { "type": "STRING", description: "採点結果の総評。良い点と改善点を1〜2文でまとめる。" },
                            // 採点の内訳（スコアと詳細）
                            "correctnessScore": { "type": "INTEGER", description: "論理の正確さ（満点10点）の取得点数" },
                            "correctnessDetail": { "type": "STRING", description: "論理の正確さ（筋道）に関する詳細なフィードバック。どの要素が不足しているかなどを具体的に指摘する。" },
                            "reasoningScore": { "type": "INTEGER", description: "根拠の明確さ（満点6点）の取得点数" },
                            "reasoningDetail": { "type": "STRING", description: "根拠の明確さ（仮定、対頂角、錯角などの使用）に関する詳細なフィードバック。" },
                            "expressionScore": { "type": "INTEGER", description: "表現の適切さ（満点4点）の取得点数" },
                            "expressionDetail": { "type": "STRING", description: "表現の適切さ（数学的用語や記号）に関する詳細なフィードバック。" },
                            "modelProofSummary": { "type": "STRING", description: "模範的な証明文の要点（使用した条件など）を生徒の言葉で分かりやすくまとめたもの。" }
                        },
                        required: ["score", "feedbackSummary", "correctnessScore", "correctnessDetail", "reasoningScore", "reasoningDetail", "expressionScore", "expressionDetail", "modelProofSummary"]
                    }
                }
            };

            let response;
            let maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        await sleep(Math.pow(2, i) * 1000);
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`API response status: ${response.status}`);
                    }
                    break; 

                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    if (i === maxRetries - 1) {
                        feedbackOutput.innerHTML = `<p class="text-red-600 font-semibold">エラーが発生しました。時間をおいて再試行してください。</p>`;
                        loadingIndicator.classList.add('hidden');
                        gradeButton.disabled = false;
                        return;
                    }
                    await sleep(Math.pow(2, i) * 1000);
                }
            }


            try {
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonText = candidate.content.parts[0].text;
                    const feedback = JSON.parse(jsonText);

                    displayFeedback(feedback);

                } else {
                    throw new Error("Invalid response structure from API.");
                }
            } catch (error) {
                console.error("Error processing API response:", error);
                feedbackOutput.innerHTML = `<p class="text-red-600 font-semibold">AIからの応答を処理中にエラーが発生しました。入力内容を確認してください。</p>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                gradeButton.disabled = false;
                modelProofArea.classList.remove('hidden'); // 模範解答を表示
            }
        }

        /**
         * Renders the feedback received from the AI.
         * @param {object} feedback - The parsed JSON feedback object.
         */
        function displayFeedback(feedback) {
            feedbackOutput.innerHTML = `
                <div class="mb-6 pb-4 border-b-2 border-green-500">
                    <p class="text-3xl font-extrabold text-green-700">合計点: <span class="text-4xl">${feedback.score}</span> / 20点</p>
                    <p class="mt-2 text-xl font-semibold text-gray-700">${feedback.feedbackSummary}</p>
                </div>

                <div class="space-y-5">
                    <!-- 詳細フィードバック -->
                    <div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                        <h3 class="font-bold text-lg text-blue-700 mb-1">論理の正確さ（筋道） <span class="text-base font-extrabold text-red-600">(${feedback.correctnessScore} / 10点)</span></h3>
                        <p class="text-gray-700 text-sm">${feedback.correctnessDetail}</p>
                    </div>

                    <div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                        <h3 class="font-bold text-lg text-blue-700 mb-1">根拠の明確さ（理由） <span class="text-base font-extrabold text-red-600">(${feedback.reasoningScore} / 6点)</span></h3>
                        <p class="text-gray-700 text-sm">${feedback.reasoningDetail}</p>
                    </div>

                    <div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                        <h3 class="font-bold text-lg text-blue-700 mb-1">表現の適切さ（書き方） <span class="text-base font-extrabold text-red-600">(${feedback.expressionScore} / 4点)</span></h3>
                        <p class="text-gray-700 text-sm">${feedback.expressionDetail}</p>
                    </div>

                    <!-- 模範解答の要点 --><div class="pt-4 border-t border-gray-200">
                        <h3 class="font-bold text-xl text-red-600 mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>
                            模範証明のポイント
                        </h3>
                        <p class="text-gray-800">${feedback.modelProofSummary}</p>
                    </div>
                </div>
            `;
        }

        // ページロード時に実行
        window.onload = initializeProblemSelector;
    </script>
</body>
</html>
