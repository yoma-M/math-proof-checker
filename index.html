<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三角形の合同 証明採点アプリ</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Font setting --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
        /* SVG内の文字のフォント設定 (削除したが念のため残す) */
        .svg-label {
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            fill: #333;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-10">

        <!-- Header -->
        <header class="mb-8 flex flex-col items-center relative">
            <div class="text-center">
                <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-700">証明採点</h1>
                <p class="text-lg text-gray-600 mt-2">論理的に表現する力を身につけよう</p>
            </div>
        </header>

        <!-- Problem Selector -->
        <section class="mb-6">
            <label for="problemSelector" class="block text-xl font-bold text-gray-800 mb-2">問題を選択</label>
            <select id="problemSelector" class="w-full p-3 border-2 border-green-500 rounded-lg bg-white text-lg focus:ring-4 focus:ring-green-400" onchange="loadProblem(this.value)">
                <!-- Options populated by JavaScript -->
            </select>
        </section>

        <!-- Input Area -->
        <section class="mb-8">
            <label for="proofInput" class="block text-xl font-bold text-gray-800 mb-2">あなたの証明文（テキスト入力または画像アップロード）</label>
            
            <!-- テキスト入力 -->
            <textarea id="proofInput" rows="5" class="w-full p-4 border-2 border-blue-300 rounded-lg focus:ring-4 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-inner resize-y mb-4" placeholder="証明をここに入力してください。（画像アップロードの場合は空欄でOK）"></textarea>

            <!-- 画像アップロード -->
            <div class="flex flex-col sm:flex-row items-center gap-4 p-4 border-2 border-dashed border-gray-400 rounded-lg bg-gray-50">
                <input type="file" id="imageInput" accept="image/*" class="text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <img id="imagePreview" class="hidden max-h-32 rounded-lg shadow-md border border-gray-300 object-contain" alt="アップロードされた証明のプレビュー" />
            </div>

            <button id="submitButton" class="w-full sm:w-auto mt-4 px-8 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-400 transition duration-150 transform hover:scale-[1.01] disabled:bg-gray-400 disabled:cursor-not-allowed" onclick="gradeProof()" disabled>
                採点する
            </button>
        </section>

        <!-- Result/Feedback Area -->
        <section id="resultSection" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                採点結果とフィードバック
            </h2>
            <div id="loadingIndicator" class="hidden text-center p-8 bg-yellow-100 rounded-lg border border-yellow-300">
                <svg class="animate-spin h-8 w-8 text-yellow-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-3 text-lg font-medium text-yellow-700">採点中... AIが証明の論理をチェックしています。</p>
            </div>
            <div id="feedbackOutput" class="p-6 bg-white border border-gray-300 rounded-lg shadow-md">
                <!-- 採点結果がここに挿入されます -->
            </div>
             <!-- 模範解答の表示エリア -->
            <div id="modelProofArea" class="hidden mt-6 p-6 bg-green-50 border-2 border-green-300 rounded-xl shadow-inner">
                <h3 class="font-bold text-xl text-green-800 mb-3 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    先生の模範解答
                </h3>
                <pre id="modelProofText" class="whitespace-pre-wrap font-mono text-sm text-gray-800 bg-white p-3 rounded border border-gray-200"></pre>
            </div>
        </section>

    </div>

    <!-- JavaScript and Firebase Setup (Must use type="module") --><script type="module">
        // 🚨 IMPORTANT: Replace this with your actual Gemini API Key if deploying on GitHub Pages.
        // NOTE: GAS_WEB_APP_URLの代わりにAPIキーを直接使用します。
        const GEMINI_API_KEY = "AIzaSyB64np3ZL8ysnZLaFQm8N3VPW_agxEaJhs"; // <<< ここにキーを貼り付けます！
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        // ... (問題定義と関数 getSystemPrompt, displayFeedback)

        // --- 問題定義は省略 ---

        // =================================================================
        // 【問題データの定義】: 問題文とAIへの指示を修正しました。
        // =================================================================
        const PROBLEMS = [
            {
                id: '1',
                title: '証明問題①',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】線分 AD と BC の交点を E とします。仮定が AE = BE, AD // BC のとき、△AED ≡ △BEC であることを証明しなさい。また、ED = EC であることを導きなさい。</p>
                    <p class="text-sm mt-1 text-gray-500">※この問題は、AE=EBとAD//BCが仮定として与えられているものとします。</p>`,
                modelProof: `
【証明】
△AED と △BEC において、

1.  仮定より、
    AE = BE … ①
2.  AD // BC の錯角は等しいから、
    ∠EDA = ∠EBC … ② (または ∠DAE = ∠CBE)
    ※錯角のペアは ∠EDA と ∠EBC、および ∠DAE と ∠CBE の２通りがあります。
3.  対頂角は等しいので、
    ∠AED = ∠BEC … ③

①、②、③より、1組の辺とその両端の角がそれぞれ等しいので、
△AED ≡ △BEC
合同な図形の対応する辺は等しいから、
ED = EC
`,
                aiInstruction: {
                    problem: '図（AE = BE, AD // BC）で、△AED ≡ △BEC を証明し、ED = ECを導け。',
                    condition: '1組の辺とその両端の角がそれぞれ等しい'
                }
            },
            {
                id: '2',
                title: '証明問題②',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】線分 AC と BD の交点を O とします。仮定が OA = OB, OC = OD のとき、△OAC ≡ △OBD であることを証明しなさい。また、∠OAC = ∠OBD であることを導きなさい。</p>`,
                modelProof: `
【証明】
△OAC と △OBD において、

1.  仮定より、
    OA = OB … ①
2.  仮定より、
    OC = OD … ②
3.  対頂角は等しいので、
    ∠AOC = ∠BOD … ③

①、②、③より、2組の辺とその間の角がそれぞれ等しいので、
△OAC ≡ △OBD
合同な図形の対応する角は等しいから、
∠OAC = ∠OBD
`,
                aiInstruction: {
                    problem: '図（ACとBDの交点がO、OA = OB, OC = OD）で、△OAC ≡ △OBD を証明し、∠OAC = ∠OBD を導け。',
                    condition: '2組の辺とその間の角がそれぞれ等しい'
                }
            },
            {
                id: '3',
                title: '証明問題③',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】四角形 ABCD で、AB = DC, AC = DB が成り立つとき、△ABC ≡ △DCB であることを証明しなさい。</p>`,
                modelProof: `
【証明】
△ABC と △DCB において、

1.  仮定より、
    AB = DC … ①
2.  仮定より、
    AC = DB … ②
3.  共通な辺だから、
    BC = CB … ③

①、②、③より、3組の辺がそれぞれ等しいので、
△ABC ≡ △DCB
`,
                aiInstruction: {
                    problem: '四角形 ABCD で、AB = DC, AC = DB が成り立つとき、△ABC ≡ △DCB を証明せよ。',
                    condition: '3組の辺がそれぞれ等しい'
                }
            },
            {
                id: '4',
                title: '証明問題④',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】∠XOY の二等分線上に点 C をとり、点 C から 2辺 OX, OY に下ろした垂線の足をそれぞれ A, B とします。※ただし、ここでは ∠AOC = ∠BOC と ∠ACO = ∠BCO を仮定とします。△OAC ≡ △OBC であることを証明しななさい。</p>`,
                modelProof: `
【証明】
△OAC と △OBC において、

1.  仮定より、
    ∠AOC = ∠BOC … ①
2.  仮定より、
    ∠ACO = ∠BCO … ②
3.  共通な辺だから、
    OC = OC … ③

①、②、③より、1組の辺とその両端の角がそれぞれ等しいので、
△OAC ≡ △OBC
`,
                aiInstruction: {
                    problem: '図（∠XOYの二等分線、CからOX, OYに垂線CA, CB。仮定：∠AOC = ∠BOC と ∠ACO = ∠BCO）で、△OAC ≡ △OBC を証明せよ。**ただし、この問題は「2組の角と、その間にない1組の辺」が等しいケースであり、日本の教育指導上では「1組の辺とその両端の角がそれぞれ等しい」という条件名で合格とする指導があるため、生徒がこの条件名を用いた場合は正解として扱うこと。論理の構造は (角、角、共通な辺) の順で成立していることを確認すること。**',
                    condition: '1組の辺とその両端の角がそれぞれ等しい'
                }
            },
            {
                id: '5',
                title: '証明問題⑤',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】線分 AD と BC の交点を O とします。仮定が AO = OB, CO = OD のとき、△OAC ≡ △OBD であることを証明しなさい。また、∠OAC = ∠OBD であることを導きなさい。</p>`,
                modelProof: `
【証明】
△OAC と △OBD において、

1.  仮定より、
    AO = OB … ①
2.  仮定より、
    CO = OD … ②
3.  対頂角は等しいので、
    ∠AOC = ∠BOD … ③

①、②、③より、2組の辺とその間の角がそれぞれ等しいので、
△OAC ≡ △OBD
合同な図形の対応する角は等しいから、
∠OAC = ∠OBD
`,
                aiInstruction: {
                    problem: '図（ADとBCの交点がO、AO = OB, CO = OD）で、△OAC ≡ △OBD を証明し、∠OAC = ∠OBD を導け。',
                    condition: '2組の辺とその間の角がそれぞれ等しい'
                }
            },
            {
                id: '6',
                title: '証明問題⑥',
                problemText: `<p>次の問題について証明文を作成してください。</p>
                    <p>【問題内容】図で、BA = DA, ∠ABC = ∠ADE のとき、△ABC ≡ △ADE であることを証明しなさい。また、BC = DE であることを導きなさい。</p>`,
                modelProof: `
【証明】
△ABC と △ADE において、

1.  仮定より、
    BA = DA … ①
2.  共通な角だから、
    ∠BAC = ∠DAE … ②
3.  仮定より、
    ∠ABC = ∠ADE … ③

①、②、③より、1組の辺とその両端の角がそれぞれ等しいので、
△ABC ≡ △ADE
合同な図形の対応する辺は等しいから、
BC = DE
`,
                aiInstruction: {
                    problem: '図（∠Aが共通、BA=DA、∠ABC=∠ADE）で、△ABC ≡ △ADE を証明し、BC = DE を導け。',
                    condition: '1組の辺とその両端の角がそれぞれ等しい'
                }
            }
        ];
        // =================================================================
        
        // --- 実行関数とロジック ---
        // ... (省略された関数定義)
        
        // ページロード時に実行
        window.onload = initializeProblemSelector;
        
        // --- 省略された関数定義 ---
        // 以下の関数定義は完全なコードには含まれますが、ここでは簡潔化のために省略します。
        
        /**
         * Grades the user's proof using the Gemini API and provides feedback.
         */
        window.gradeProof = async function() {
            const userProofText = proofInput.value.trim();
            const imageFile = imageInput.files[0];

            if (!userProofText && !imageFile) return;

            // ... (省略: UI設定、ロードインジケーター表示)

            submitButton.disabled = true;

            // --- API Payload Construction ---
            let parts = [];
            
            // 現在の問題の指示を使用
            let problemDescription = `
                生徒の解答を採点してください。
                【問題】${currentProblem.aiInstruction.problem} (期待される合同条件: ${currentProblem.aiInstruction.condition})
            `;

            if (imageFile) {
                // 画像がアップロードされている場合、画像を読み取りペイロードに含める
                try {
                    const base64Data = await fileToBase64(imageFile);
                    
                    // 採点指示テキスト
                    parts.push({ text: problemDescription });
                    
                    // 画像データ
                    parts.push({
                        inlineData: {
                            mimeType: base64Data.mimeType,
                            data: base64Data.data
                        }
                    });
                    
                    // 画像内の証明文を読み取るよう指示を追加
                    parts.push({ text: "画像内に書かれた証明文を読み取り、以下の採点基準で評価してください。" });

                } catch (error) {
                    console.error("Image processing error:", error);
                    feedbackOutput.innerHTML = `<p class="text-red-600 font-semibold">画像の処理中にエラーが発生しました。ファイル形式を確認してください。</p>`;
                    loadingIndicator.classList.add('hidden');
                    submitButton.disabled = false;
                    return;
                }
            } else if (userProofText) {
                // テキスト入力のみの場合
                parts.push({ text: problemDescription + `\n生徒の証明文：\n${userProofText}` });
            }
            
            // System Instruction (採点基準)
            const systemPrompt = `
                あなたは中学2年生の証明問題を採点する厳格で親切な数学の先生です。
                生徒の解答（テキストまたは画像内の証明文）を採点し、JSON形式で結果を返してください。
                // ... (省略: 採点基準の詳細)
            `;


            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    // ... (省略: responseSchema)
                }
            };

            let response;
            let maxRetries = 3;
            const finalApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(finalApiUrl, { // <--- 修正: GAS_WEB_APP_URLの代わりにfinalApiUrlを使用
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    // ... (省略: エラーハンドリング)
                    
                    break; 

                } catch (error) {
                    // ... (省略: リトライ処理)
                    
                    if (i === maxRetries - 1) {
                        feedbackOutput.innerHTML = `<p class="text-red-600 font-semibold">エラーが発生しました。時間をおいて再試行してください。APIキーを確認してください。</p>`;
                        loadingIndicator.classList.add('hidden');
                        submitButton.disabled = false;
                        return;
                    }
                    await sleep(Math.pow(2, i) * 1000);
                }
            }

            // ... (省略: レスポンス処理)
            
            // 最後に displayFeedback が呼び出される
            // displayFeedback(feedback);
        }
        
        // ... (省略: getSystemPrompt と displayFeedback 関数)
        
        function displayFeedback(feedback) { /* ... */ } 
        function getSystemPrompt() { /* ... */ return systemPrompt; } 
        function initializeProblemSelector() { /* ... */ } 
        window.loadProblem = function(index) { /* ... */ }
        function fileToBase64(file) { /* ... */ }
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        // ページロード時に実行
        window.onload = initializeProblemSelector;
    </script>
</body>
</html>
